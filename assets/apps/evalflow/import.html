<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EvalFlow - Bulk Import Students</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    
    // Replace with your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDbAgwMiEAZCezKy3t7j4ZW8xQyjgXqrKI",
      authDomain: "evalflow-b3da2.firebaseapp.com",
      projectId: "evalflow-b3da2",
      storageBucket: "evalflow-b3da2.firebasestorage.app",
      messagingSenderId: "376143096721",
      appId: "1:376143096721:web:8399e278170f1c3f4f8830",
      measurementId: "G-CRL51V7SZL"
    };
    
    const app = initializeApp(firebaseConfig);
    window.auth = getAuth(app);
    window.db = getFirestore(app);
    window.firebaseAuth = { signInWithEmailAndPassword, onAuthStateChanged };
    window.firebaseFirestore = { collection, addDoc, getDocs, query, where, serverTimestamp };
  </script>
</head>
<body class="bg-gray-50">
  <div id="root"></div>
  
  <script type="module">
    const { useState, useEffect } = React;
    
    function BulkImport() {
      const [currentUser, setCurrentUser] = useState(null);
      const [loginEmail, setLoginEmail] = useState('');
      const [loginPassword, setLoginPassword] = useState('');
      const [file, setFile] = useState(null);
      const [sections, setSections] = useState([]);
      const [groups, setGroups] = useState([]);
      const [preview, setPreview] = useState([]);
      const [importing, setImporting] = useState(false);
      const [progress, setProgress] = useState('');
      const [error, setError] = useState('');
      const [success, setSuccess] = useState('');
      
      useEffect(() => {
        const unsubscribe = window.firebaseAuth.onAuthStateChanged(window.auth, (user) => {
          if (user) {
            setCurrentUser(user);
            loadData();
          }
        });
        return unsubscribe;
      }, []);
      
      const loadData = async () => {
        const { collection, getDocs } = window.firebaseFirestore;
        
        const sectionsSnap = await getDocs(collection(window.db, 'sections'));
        const sectionsData = sectionsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setSections(sectionsData);
        
        const groupsSnap = await getDocs(collection(window.db, 'groups'));
        const groupsData = groupsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setGroups(groupsData);
      };
      
      const handleLogin = async (e) => {
        e.preventDefault();
        setError('');
        try {
          await window.firebaseAuth.signInWithEmailAndPassword(window.auth, loginEmail, loginPassword);
        } catch (err) {
          setError('Login failed: ' + err.message);
        }
      };
      
      const handleFileChange = (e) => {
        const selectedFile = e.target.files[0];
        if (selectedFile) {
          setFile(selectedFile);
          parseFile(selectedFile);
        }
      };
      
      const parseFile = (file) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const text = e.target.result;
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            
            const data = [];
            for (let i = 1; i < lines.length; i++) {
              if (!lines[i].trim()) continue;
              
              const values = lines[i].split(',').map(v => v.trim());
              const row = {};
              headers.forEach((header, index) => {
                row[header] = values[index] || '';
              });
              data.push(row);
            }
            
            setPreview(data);
            setError('');
          } catch (err) {
            setError('Failed to parse file. Please check format.');
          }
        };
        reader.readAsText(file);
      };
      
      const handleImport = async () => {
        if (!preview.length) {
          setError('No data to import');
          return;
        }
        
        setImporting(true);
        setProgress('Starting import...');
        let imported = 0;
        let skipped = 0;
        
        try {
          const { collection, addDoc, serverTimestamp } = window.firebaseFirestore;
          
          for (let i = 0; i < preview.length; i++) {
            const student = preview[i];
            setProgress(`Importing ${i + 1} of ${preview.length}...`);
            
            // Find section
            const sectionName = student.section || student.sectionname || student['section name'];
            const section = sections.find(s => 
              s.name.toLowerCase().includes(sectionName.toLowerCase())
            );
            
            if (!section) {
              console.warn(`Section not found for: ${sectionName}`);
              skipped++;
              continue;
            }
            
            // Add student
            await addDoc(collection(window.db, 'students'), {
              name: student.name || student.studentname || '',
              email: (student.email || '').toLowerCase(),
              studentId: student.id || student.studentid || student['student id'] || '',
              sectionId: section.id,
              presentationOrder: parseInt(student.order || student.presentationorder || '999'),
              createdAt: serverTimestamp()
            });
            
            imported++;
            
            // Handle group if specified
            const groupNum = student.group || student.groupnumber || student['group number'];
            if (groupNum) {
              const groupName = `Group ${groupNum}`;
              let group = groups.find(g => 
                g.name === groupName && g.sectionId === section.id
              );
              
              if (!group) {
                // Create group
                const groupRef = await addDoc(collection(window.db, 'groups'), {
                  name: groupName,
                  sectionId: section.id,
                  members: [],
                  createdAt: serverTimestamp()
                });
                group = { id: groupRef.id, name: groupName, sectionId: section.id, members: [] };
                groups.push(group);
              }
            }
            
            // Small delay to avoid rate limiting
            await new Promise(resolve => setTimeout(resolve, 100));
          }
          
          setSuccess(`Import complete! Added ${imported} students. Skipped ${skipped}.`);
          setProgress('');
          setPreview([]);
          setFile(null);
          loadData();
        } catch (err) {
          setError('Import failed: ' + err.message);
        } finally {
          setImporting(false);
        }
      };
      
      const downloadTemplate = () => {
        const template = `Name,Email,Student ID,Section,Order,Group
John Doe,john@university.edu,12345,Section A - MWF 9am,1,1
Jane Smith,jane@university.edu,12346,Section A - MWF 9am,2,1
Bob Johnson,bob@university.edu,12347,Section A - MWF 9am,3,2`;
        
        const blob = new Blob([template], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'evalflow_import_template.csv';
        a.click();
      };
      
      if (!currentUser) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
              <div className="text-center mb-8">
                <h1 className="text-3xl font-bold text-indigo-600 mb-2">EvalFlow</h1>
                <p className="text-gray-600">Bulk Student Import</p>
              </div>
              
              {error && (
                <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                  {error}
                </div>
              )}
              
              <form onSubmit={handleLogin} className="space-y-4">
                <input
                  type="email"
                  placeholder="Instructor Email"
                  value={loginEmail}
                  onChange={(e) => setLoginEmail(e.target.value)}
                  required
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                />
                <input
                  type="password"
                  placeholder="Password"
                  value={loginPassword}
                  onChange={(e) => setLoginPassword(e.target.value)}
                  required
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                />
                <button
                  type="submit"
                  className="w-full bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700"
                >
                  Login
                </button>
              </form>
            </div>
          </div>
        );
      }
      
      return (
        <div className="min-h-screen bg-gray-50 py-8 px-4">
          <div className="max-w-4xl mx-auto">
            <div className="bg-white rounded-xl shadow-lg p-8">
              <h1 className="text-3xl font-bold text-indigo-600 mb-2">Bulk Student Import</h1>
              <p className="text-gray-600 mb-8">Upload a CSV or Excel file to import multiple students at once</p>
              
              {error && (
                <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
                  {error}
                </div>
              )}
              
              {success && (
                <div className="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg text-green-700">
                  {success}
                </div>
              )}
              
              {progress && (
                <div className="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg text-blue-700">
                  {progress}
                </div>
              )}
              
              <div className="space-y-6">
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-6">
                  <h3 className="font-semibold text-blue-900 mb-3">CSV Format Required:</h3>
                  <div className="bg-white rounded p-3 font-mono text-sm overflow-x-auto">
                    <div className="font-bold mb-1">Name,Email,Student ID,Section,Order,Group</div>
                    <div>John Doe,john@univ.edu,12345,Section A - MWF 9am,1,1</div>
                    <div>Jane Smith,jane@univ.edu,12346,Section A - MWF 9am,2,1</div>
                  </div>
                  <button
                    onClick={downloadTemplate}
                    className="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                  >
                    Download Template
                  </button>
                </div>
                
                <div className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                  <input
                    type="file"
                    accept=".csv,.xlsx,.xls"
                    onChange={handleFileChange}
                    className="hidden"
                    id="file-upload"
                  />
                  <label
                    htmlFor="file-upload"
                    className="cursor-pointer inline-flex items-center px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                  >
                    Choose CSV File
                  </label>
                  {file && (
                    <p className="mt-4 text-gray-600">Selected: {file.name}</p>
                  )}
                </div>
                
                {preview.length > 0 && (
                  <div>
                    <h3 className="text-lg font-semibold mb-4">Preview ({preview.length} students)</h3>
                    <div className="overflow-x-auto max-h-96 border rounded-lg">
                      <table className="w-full text-sm">
                        <thead className="bg-gray-50 sticky top-0">
                          <tr>
                            <th className="px-4 py-2 text-left">Name</th>
                            <th className="px-4 py-2 text-left">Email</th>
                            <th className="px-4 py-2 text-left">ID</th>
                            <th className="px-4 py-2 text-left">Section</th>
                            <th className="px-4 py-2 text-left">Order</th>
                            <th className="px-4 py-2 text-left">Group</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y">
                          {preview.slice(0, 50).map((student, idx) => (
                            <tr key={idx} className="hover:bg-gray-50">
                              <td className="px-4 py-2">{student.name || student.studentname}</td>
                              <td className="px-4 py-2">{student.email}</td>
                              <td className="px-4 py-2">{student.id || student.studentid || student['student id']}</td>
                              <td className="px-4 py-2">{student.section || student.sectionname || student['section name']}</td>
                              <td className="px-4 py-2">{student.order || student.presentationorder || '-'}</td>
                              <td className="px-4 py-2">{student.group || student.groupnumber || student['group number'] || '-'}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                      {preview.length > 50 && (
                        <div className="p-4 bg-gray-50 text-center text-gray-600">
                          Showing first 50 of {preview.length} students
                        </div>
                      )}
                    </div>
                    
                    <div className="flex gap-4 mt-6">
                      <button
                        onClick={handleImport}
                        disabled={importing}
                        className="flex-1 bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        {importing ? 'Importing...' : `Import ${preview.length} Students`}
                      </button>
                      <button
                        onClick={() => {
                          setPreview([]);
                          setFile(null);
                        }}
                        className="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50"
                      >
                        Cancel
                      </button>
                    </div>
                  </div>
                )}
                
                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                  <h4 className="font-semibold text-yellow-900 mb-2">Important Notes:</h4>
                  <ul className="text-yellow-800 text-sm space-y-1 list-disc list-inside">
                    <li>Section names must match exactly (e.g., "Section A - MWF 9am")</li>
                    <li>Create sections first in the main EvalFlow app before importing</li>
                    <li>Group numbers will auto-create groups if they don't exist</li>
                    <li>Order determines presentation sequence (1, 2, 3...)</li>
                    <li>Import may take a few minutes for large files</li>
                  </ul>
                </div>
                
                <div className="text-center pt-4">
                  <a
                    href="/apps/evalflow/"
                    className="text-indigo-600 hover:text-indigo-700 font-medium"
                  >
                    ← Back to EvalFlow
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }
    
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(BulkImport));
  </script>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
</body>
</html>
